---
# This is exact copy of main playbook, except kamaln7.swapfile is skipped
# because it's not possible to test it on Travis CI. Also we manually add
# vagrant user as it does not exist in Docker.
- hosts: all
  remote_user: root

  pre_tasks:
    - name: Ensure base packages are installed
      apt:
        name: '{{ item }}'
        state: present
        update_cache: yes
        cache_valid_time: 86400
      with_items:
        - curl
        - git
        - rsyslog
        - tzdata
        - unzip
        - wget
    - name: Set timezone
      timezone:
        name: '{{ vagrant.timezone }}'
    - name: Add vagrant user
      user:
        name: vagrant
        password: vagrant
        uid: 1000
        groups: syslog
        append: yes
    - name: Ensure that logs directories exist
      file:
        path: '{{ item }}'
        state: directory
        mode: 0755
        group: vagrant
        owner: vagrant
      with_items:
        - /var/log/draft
    # Required by Deamonize, which is required by MailHog
    - name: Ensure build-essential package is installed
      apt:
        name: build-essential
        state: present
      when: "'mailhog' in draft_features"

  roles:
    - { role: kamaln7.swapfile, swapfile_size: false }
    - geerlingguy.mailhog
    - git_config
    - apache2
    - mysql
    - T2L.php
    - T2L.composer
    - T2L.java
    - { role: T2L.solr, solr_cleanup_downloads: false, solr_cleanup_gpg: false }
  vars_files:
    - vars/swapfile.yml
    - vars/php.yml
    - vars/solr.yml
    - vars/mailhog.yml
    - ../../vm-settings.yml
